<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হোম - Taka GorBD</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --main-red: #E74C3C; /* Bright Red */
            --white: #FFFFFF;
            --dark-red: #C0392B;
            --light-gray: #F0F0F0;
            --text-color: #333333;
            --border-radius-large: 30px; /* More rounded as per screenshot */
            --border-radius-small: 15px; /* For buttons and inner elements */
            --input-height: 50px;
            --green-claim: #2ECC71; /* Green for claim button */
            --orange-help: #FFA500; /* Orange for help button */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--main-red); /* Solid red background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-color);
            overflow-x: hidden;
            position: relative;
        }

        .container {
            background-color: var(--main-red); /* Container also red */
            width: 100%;
            max-width: 400px; /* Fixed width as per screenshot */
            padding: 0; /* Cards handle their own padding */
            box-sizing: border-box;
            position: relative;
        }

        .logout-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--white);
            font-size: 1.1em;
            cursor: pointer;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white background */
            padding: 5px 10px;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .logout-menu:hover {
            opacity: 0.9;
        }

        .balance-card {
            background-color: var(--white);
            border-radius: var(--border-radius-large);
            padding: 30px 20px;
            margin-top: 60px; /* Space for logout button */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .balance-card h3 {
            font-size: 1.2em;
            color: var(--text-color);
            margin-bottom: 5px; /* Tighter spacing */
            font-weight: 500;
        }
        .balance-display {
            font-family: 'Fredoka One', cursive; /* Funky font for balance */
            font-size: 1.8em; /* Adjusted font size for balance - MUCH SMALLER */
            font-weight: 700;
            color: var(--main-red); /* Red balance as per image */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            position: relative;
            height: 1.2em; /* Ensure fixed height for animation */
            overflow: hidden; /* Hide overflow during animation */
            white-space: nowrap; /* Prevent wrapping */
        }
        .balance-amount {
            position: relative;
            display: inline-block;
        }
        .balance-amount span {
            display: inline-block;
            transition: transform 0.1s ease-out; /* Smooth digit transition */
        }
        .balance-display .taka-icon {
            font-size: 0.8em;
            margin-right: 5px;
            color: #2ECC71; /* Green Taka sign */
        }
        .speed-level {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-bottom: 20px;
            font-weight: 500;
        }
        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.2em;
            color: var(--text-color);
            font-weight: 500;
        }
        .user-info .emoji {
            font-size: 1.5em;
        }

        .section-card { /* Unified style for referral and task sections */
            background-color: var(--white);
            border-radius: var(--border-radius-large);
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: left; /* Align content to left within card */
        }
        .section-card h3 {
            font-size: 1.1em;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 10px;
        }

        .input-group-custom { /* For "Your Refer code" and "submit refer code" */
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background-color: var(--light-gray); /* Light gray background for input groups */
            border-radius: var(--border-radius-small);
            overflow: hidden; /* To keep inner elements within rounded corners */
            height: var(--input-height); /* Fixed height */
        }
        .input-group-custom span.code-display,
        .input-group-custom input {
            flex-grow: 1;
            padding: 0 15px;
            font-size: 0.95em;
            color: var(--text-color);
            background: none; /* No background, use parent's */
            border: none;
            outline: none;
            height: 100%; /* Fill parent height */
            box-sizing: border-box;
            line-height: var(--input-height); /* Vertically center text */
        }
        .input-group-custom button {
            background-color: var(--main-red);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-small); /* Rounded button inside group */
            padding: 0 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap;
            height: 100%; /* Fill parent height */
            box-sizing: border-box;
            /* Added min-width to ensure button doesn't shrink too much */
            min-width: 80px; /* Adjusted to ensure visibility */
        }
        .input-group-custom button:hover {
            background-color: var(--dark-red);
        }

        .referral-stats {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 10px;
            text-align: left;
        }
        .referral-stats strong {
            color: var(--text-color);
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 10px;
            padding: 10px; /* Padding for the task item itself */
            background-color: var(--light-gray); /* Background for the whole task item */
            border-radius: var(--border-radius-small);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inner shadow */
        }
        .task-item .task-details {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            cursor: pointer;
        }
        .task-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .task-item .task-text {
            color: var(--text-color);
            font-size: 0.95em;
            font-weight: 500;
        }
        .task-item .task-text .money-icon {
            color: var(--green-claim);
            margin-left: 5px;
        }
        .task-item .claim-btn {
            background-color: var(--green-claim);
            color: var(--white);
            border-radius: var(--border-radius-small);
            padding: 10px 15px;
            font-size: 0.9em;
            height: auto; /* Allow button to size to content */
        }
        .task-item .claim-btn:hover {
            background-color: #27AE60;
        }
        .task-item .claim-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }

        .message {
            margin-top: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            display: none;
            text-align: center;
        }
        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Help Center Button (fixed on bottom right) */
        .help-center-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--orange-help);
            color: var(--white);
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            animation: pulse 1.5s infinite;
        }
        .help-center-btn:hover {
            background-color: #E69500;
            transform: scale(1.05);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 165, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logout-menu" onclick="logout()">
            logout <i class="fas fa-bars"></i>
        </div>
        <div class="balance-card">
            <h3>Balance</h3>
            <div class="balance-display">
                <span class="taka-icon">৳</span>
                <span id="taka-part" class="balance-amount-segment">00</span>.
                <span id="paisa-part" class="balance-amount-segment">00</span>.
                <span id="sub-paisa1-part" class="balance-amount-segment">000</span>.
                <span id="sub-paisa2-part" class="balance-amount-segment">000</span>
            </div>
            <p class="speed-level">Speed Level: <span id="mining-speed-display">10%</span></p>
            <div class="user-info">
                <span class="emoji">👋</span> <span id="user-name-display">User Name</span>
            </div>
        </div>

        <div class="section-card referral-section">
            <h3>Referral</h3>
            <div class="input-group-custom">
                <span class="code-display" id="user-refer-code">TGBD-XXXXX</span>
                <button onclick="copyReferralCode()">copy</button>
            </div>
            <div class="input-group-custom">
                <input type="text" id="submit-refer-code" placeholder="submit refer code">
                <button onclick="submitReferralCode()">submit</button>
            </div>
            <p class="referral-stats">You referred: <strong id="referred-count">0</strong> users</p>
            <p id="referral-message" class="message"></p>
        </div>

        <div class="section-card task-section">
            <h3>Task</h3>
            <div class="task-item">
                <div class="task-details">
                    <img src="https://via.placeholder.com/40/FF0000/FFFFFF?text=T" alt="Task User"> <p class="task-text">10 টাকা <i class="fas fa-money-bill-wave money-icon"></i></p>
                </div>
                <button id="task-claim-btn" onclick="claimTask()" disabled>Claim</button>
            </div>
            <p id="task-message" class="message"></p>
        </div>
    </div>

    <a href="https://t.me/Taka_GorBD" target="_blank" class="help-center-btn" title="হেল্প সেন্টার - যেকোনো প্রয়োজনে যোগাযোগ করুন">
        <i class="fas fa-question"></i>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, get, update, query, orderByValue, equalTo } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA0nwj-qooOderNiLvmILB-gIPouy2HG4c",
          authDomain: "takagorbd.firebaseapp.com",
          databaseURL: "https://takagorbd-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "takagorbd",
          storageBucket: "takagorbd.firebasestorage.app",
          messagingSenderId: "531548262665",
          appId: "1:531548262665:web:85fb34ea635dae7ddc43d8",
          measurementId: "G-TZB0NHKYGY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentUserUid = null;
        let miningInterval;

        // Global functions for HTML access
        window.showMessage = function(elementId, msg, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = msg;
            messageElement.className = `message message-${type}`;
            messageElement.style.display = 'block';
            setTimeout(() => {
                window.hideMessage(elementId);
            }, 5000);
        };

        window.hideMessage = function(elementId = null) {
            if (elementId) {
                document.getElementById(elementId).style.display = 'none';
            }
        };

        // Check auth state on page load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUid = user.uid;
                loadUserDataAndStartMining();
            } else {
                // User is signed out, redirect to login page
                window.location.href = 'login.html';
            }
        });

        async function loadUserDataAndStartMining() {
            if (!currentUserUid) return;

            try {
                const userRef = ref(database, 'users/' + currentUserUid);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    updateHomePageData(userData);
                    startMining(userData); // Pass initial user data to start mining
                } else {
                    console.error("User data not found in database.");
                    logout(); // Force logout if user data is missing
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                logout(); // Force logout on error
            }
        }

        function updateHomePageData(userData) {
            document.getElementById('user-name-display').textContent = userData.name;
            document.getElementById('mining-speed-display').textContent = `${userData.miningSpeed || 10}%`; // Default 10% if not set
            document.getElementById('user-refer-code').textContent = userData.referralCode;
            document.getElementById('referred-count').textContent = userData.referralCount || 0;

            const claimBtn = document.getElementById('task-claim-btn');
            if (userData.taskClaimed) {
                claimBtn.textContent = 'Claimed';
                claimBtn.disabled = true;
                claimBtn.style.backgroundColor = '#ccc';
            } else {
                claimBtn.textContent = 'Claim';
                claimBtn.disabled = false;
                claimBtn.style.backgroundColor = 'var(--green-claim)';
            }
        }

        async function startMining(initialUserData) {
            if (miningInterval) {
                clearInterval(miningInterval);
            }

            let currentUserData = initialUserData;
            const takaPart = document.getElementById('taka-part');
            const paisaPart = document.getElementById('paisa-part');
            const subPaisa1Part = document.getElementById('sub-paisa1-part');
            const subPaisa2Part = document.getElementById('sub-paisa2-part');


            const dailyEarnings = 10; // 10 BDT per 24 hours
            const millisecondsPerDay = 24 * 60 * 60 * 1000;
            const updateFrequency = 100; // Update every 100 milliseconds for smooth animation

            // Calculate earnings from last session
            const now = Date.now();
            const lastTime = typeof currentUserData.lastMiningTime === 'number' ? currentUserData.lastMiningTime : now;
            const timeElapsedSinceLastLogin = now - lastTime;

            const earningsToAdd = (timeElapsedSinceLastLogin / millisecondsPerDay) * dailyEarnings * ((currentUserData.miningSpeed || 10) / 100);
            currentUserData.balance = parseFloat(((currentUserData.balance || 0) + earningsToAdd).toFixed(8)); // Store with higher precision for 8 decimals
            currentUserData.lastMiningTime = now;

            // Update database with calculated earnings
            await update(ref(database, 'users/' + currentUserUid), {
                balance: currentUserData.balance, // Store with high precision
                lastMiningTime: currentUserData.lastMiningTime
            });

            // Start continuous mining
            miningInterval = setInterval(async () => {
                if (!currentUserUid) {
                    clearInterval(miningInterval);
                    return;
                }

                // Fetch the latest user data to ensure accuracy
                const userRef = ref(database, 'users/' + currentUserUid);
                const snapshot = await get(userRef);
                if (!snapshot.exists()) {
                    clearInterval(miningInterval);
                    window.logout(); // Use window.logout for global access
                    return;
                }
                currentUserData = snapshot.val(); // Get latest data

                const currentNow = Date.now();
                const timeSinceLastUpdate = currentNow - currentUserData.lastMiningTime;

                // Calculate incremental earnings based on the actual time elapsed since last update
                const incrementalEarnings = (timeSinceLastUpdate / millisecondsPerDay) * dailyEarnings * ((currentUserData.miningSpeed || 10) / 100);
                currentUserData.balance = parseFloat(((currentUserData.balance || 0) + incrementalEarnings).toFixed(8)); // Maintain 8 decimal places
                currentUserData.lastMiningTime = currentNow;

                // Update database
                await update(userRef, {
                    balance: currentUserData.balance, // Store with high precision
                    lastMiningTime: currentUserData.lastMiningTime
                });
                
                // Update display immediately (Frontend animation) XX.YY.ZZZ.PPP format
                const totalBalance = currentUserData.balance;

                const taka = Math.floor(totalBalance);
                let remainingFraction = totalBalance - taka;

                let paisa = Math.floor(remainingFraction * 100); // 2 digits after decimal
                remainingFraction = remainingFraction * 100 - paisa; // New remaining fraction

                let subPaisa1 = Math.floor(remainingFraction * 1000); // Next 3 digits
                remainingFraction = remainingFraction * 1000 - subPaisa1;

                let subPaisa2 = Math.floor(remainingFraction * 1000); // Next 3 digits

                // Pad all parts with leading zeros
                const formattedTaka = taka.toString().padStart(2, '0');
                const formattedPaisa = paisa.toString().padStart(2, '0');
                const formattedSubPaisa1 = subPaisa1.toString().padStart(3, '0');
                const formattedSubPaisa2 = subPaisa2.toString().padStart(3, '0');

                takaPart.textContent = formattedTaka;
                paisaPart.textContent = formattedPaisa;
                subPaisa1Part.textContent = formattedSubPaisa1;
                subPaisa2Part.textContent = formattedSubPaisa2;


            }, updateFrequency);
        }


        window.logout = async function() {
            try {
                clearInterval(miningInterval); // Stop mining
                await signOut(auth);
                // Redirect will be handled by onAuthStateChanged listener
            } catch (error) {
                console.error("Error logging out:", error);
            }
        };

        window.copyReferralCode = function() {
            const referralCodeElement = document.getElementById('user-refer-code');
            const textArea = document.createElement('textarea');
            textArea.value = referralCodeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            textArea.remove();
            showMessage('referral-message', 'রেফার কোড কপি হয়েছে!', 'success');
        };

        window.submitReferralCode = async function() {
            if (!currentUserUid) {
                showMessage('referral-message', 'রেফার কোড সাবমিট করতে প্রথমে লগইন করুন।', 'error');
                return;
            }

            const submittedCode = document.getElementById('submit-refer-code').value.trim();
            if (!submittedCode) {
                showMessage('referral-message', 'দয়া করে একটি রেফার কোড দিন।', 'error');
                return;
            }

            const currentUserRef = ref(database, 'users/' + currentUserUid);
            const currentUserSnapshot = await get(currentUserRef);
            const currentUserData = currentUserSnapshot.val();

            if (currentUserData.referredBy) {
                showMessage('referral-message', 'আপনি ইতিমধ্যে একটি রেফার কোড ব্যবহার করেছেন।', 'error');
                return;
            }
            if (currentUserData.referralCode === submittedCode) {
                showMessage('referral-message', 'আপনি নিজের রেফার কোড ব্যবহার করতে পারবেন না।', 'error');
                return;
            }

            try {
                // Find referrer UID by referral code
                const referrerUidSnapshot = await get(ref(database, 'referralCodes/' + submittedCode));
                let referrerUid = null;
                if (referrerUidSnapshot.exists()) {
                    referrerUid = referrerUidSnapshot.val(); // Get the UID from the submittedCode path
                }

                if (referrerUid && referrerUid !== currentUserUid) { // Ensure not self-referral
                    const referrerUserRef = ref(database, 'users/' + referrerUid);
                    const referrerUserSnapshot = await get(referrerUserRef);
                    const referrerUserData = referrerUserSnapshot.val();

                    // Update current user's data
                    await update(currentUserRef, {
                        referredBy: referrerUid,
                        miningSpeed: (currentUserData.miningSpeed || 10) + 10, // User gets 10% speed bonus
                        balance: parseFloat(((currentUserData.balance || 0) + 50).toFixed(8)) // User gets 50 BDT bonus, fixed to 8 decimal places
                    });

                    // Update referrer's data
                    await update(referrerUserRef, {
                        referralCount: (referrerUserData.referralCount || 0) + 1,
                        miningSpeed: (referrerUserData.miningSpeed || 10) + 1 // Referrer gets 1% speed bonus per referral
                    });
                    
                    // Reload user data and restart mining to apply changes
                    await loadUserDataAndStartMining();
                    showMessage('referral-message', `রেফার কোড সফলভাবে সাবমিট হয়েছে! আপনি ৫০ টাকা বোনাস পেয়েছেন এবং মাইনিং স্পিড ১০% বেড়েছে!`, 'success');
                    document.getElementById('submit-refer-code').value = '';
                } else {
                    showMessage('referral-message', 'অকার্যকর রেফার কোড।', 'error');
                }
            } catch (error) {
                console.error("Error submitting referral code:", error);
                showMessage('referral-message', 'রেফার কোড সাবমিট করতে সমস্যা হয়েছে।', 'error');
            }
        };

        window.claimTask = async function() {
            if (!currentUserUid) {
                showMessage('task-message', 'টাস্ক ক্লেইম করতে প্রথমে লগইন করুন।', 'error');
                return;
            }

            const currentUserRef = ref(database, 'users/' + currentUserUid);
            const currentUserSnapshot = await get(currentUserRef);
            const currentUserData = currentUserSnapshot.val();

            if (currentUserData.taskClaimed) {
                showMessage('task-message', 'আপনি ইতিমধ্যে এই টাস্কটি ক্লেইম করেছেন।', 'error');
                return;
            }

            try {
                await update(currentUserRef, {
                    balance: parseFloat(((currentUserData.balance || 0) + 10).toFixed(8)), // 10 BDT bonus, fixed to 8 decimal places
                    taskClaimed: true
                });
                
                // Reload user data and restart mining to apply changes
                await loadUserDataAndStartMining();
                showMessage('task-message', 'টাস্ক বোনাস সফলভাবে ক্লেইম করা হয়েছে! ১০ টাকা আপনার ব্যালেন্সে যোগ হয়েছে।', 'success');

                const claimBtn = document.getElementById('task-claim-btn');
                claimBtn.textContent = 'Claimed';
                claimBtn.disabled = true;
                claimBtn.style.backgroundColor = '#ccc';
            } catch (error) {
                console.error("Error claiming task:", error);
                showMessage('task-message', 'টাস্ক ক্লেইম করতে সমস্যা হয়েছে।', 'error');
            }
        };

        // Add event listener to the task image/text to simulate starting task
        document.querySelector('.task-details').addEventListener('click', function() {
            if (!currentUserUid) {
                showMessage('task-message', 'টাস্ক সম্পূর্ণ করতে প্রথমে লগইন করুন।', 'error');
                return;
            }
            // Temporarily disable click if task already claimed
            const claimBtn = document.getElementById('task-claim-btn');
            if (claimBtn.disabled) {
                showMessage('task-message', 'আপনি ইতিমধ্যে এই টাস্কটি ক্লেইম করেছেন।', 'error');
                return;
            }

            window.open('https://t.me/Taka_GorBD', '_blank'); 
            
            // Simulate task completion after some delay, then enable claim button
            setTimeout(() => {
                // Re-check if it's still not claimed to avoid race conditions
                if (currentUserUid && !document.getElementById('task-claim-btn').disabled) { // Check if disabled by Firebase update
                    const currentUserRef = ref(database, 'users/' + currentUserUid);
                    get(currentUserRef).then(snapshot => {
                        if (snapshot.exists() && !snapshot.val().taskClaimed) {
                            claimBtn.disabled = false;
                            claimBtn.textContent = 'Claim Now!';
                            claimBtn.style.backgroundColor = 'var(--green-claim)';
                            showMessage('task-message', 'আপনি এখন টাস্ক বোনাস ক্লেইম করতে পারবেন।', 'success');
                        }
                    });
                }
            }, 3000); 
        });
    </script>
</body>
    </html>

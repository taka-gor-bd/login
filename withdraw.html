<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taka Gor - উইথড্র</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2E86AB;
            --secondary-bg: #f6f5f5;
            --white-bg: #ffffff;
            --accent-orange: #F26419;
            --accent-green: #28A745;
            --text-dark: #333;
            --text-light: #555;
            --border-light: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --pending-color: #ffc107;
            --approved-color: #28A745;
            --cancelled-color: #dc3545;
            --info-bg: #e0f2f7; /* Lighter primary for info boxes */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-bg);
            margin: 0;
            padding-bottom: 80px; /* Space for premium bottom nav */
            color: var(--text-dark);
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px var(--shadow-medium);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header .logo-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 24px;
            letter-spacing: 0.5px;
        }

        .header .history-icon {
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .header .history-icon:active {
            transform: scale(0.9);
        }

        .content {
            padding: 15px; /* মোবাইল স্ক্রিনের জন্য প্যাডিং কমানো হয়েছে */
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.8em; /* রেসপনসিভ ফন্ট সাইজ */
        }

        .balance-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .balance-box {
            background-color: var(--white-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px var(--shadow-light);
            text-align: center;
            flex: 1 1 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .balance-box h3 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-light);
            font-weight: 500;
        }

        .balance-box .amount {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0;
        }

        .balance-box.main-balance .amount {
            font-size: 2.2em; /* Main balance is bigger */
        }
        .balance-box.income .amount { color: var(--accent-green); }
        .balance-box.referral .amount { color: var(--accent-orange); }

        /* Specific styling for main balance */
        .main-balance-wrapper {
            flex-basis: 100%; /* Takes full width */
            margin-bottom: 10px; /* Space between main and others */
        }
        .main-balance-wrapper .balance-box {
            background-color: var(--info-bg);
            border: 2px solid var(--primary-color);
            padding: 20px;
        }
        .secondary-balances-wrapper {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .secondary-balances-wrapper .balance-box {
            flex: 1 1 140px;
        }


        .form-section, .history-section {
            background-color: var(--white-bg);
            border-radius: 12px;
            box-shadow: 0 6px 12px var(--shadow-medium);
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            overflow-x: auto; /* For small screens if many tabs */
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0; /* Prevents text wrap */
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.95em;
        }

        .input-group select, .input-group input {
            width: calc(100% - 24px); /* Padding adjustment */
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.2);
            outline: none;
        }


        .amount-selection-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .amount-selection-buttons button {
            background-color: var(--secondary-bg);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            flex: 1 1 80px; /* Flexible width for buttons */
            min-width: 80px;
        }
        .amount-selection-buttons button.selected,
        .amount-selection-buttons button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .amount-selection-buttons button:active {
            transform: translateY(0);
        }

        .charge-display {
            background-color: var(--info-bg);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.95em;
            color: var(--text-dark);
        }
        .charge-display p {
            margin: 5px 0;
        }
        .charge-display strong {
            color: var(--primary-color);
        }
        .charge-display .final-amount {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--accent-green);
        }

        .action-button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            width: 100%;
            margin-top: 10px;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .action-button:hover:not(:disabled) {
            background-color: #226b8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        .action-button:active:not(:disabled) {
            transform: translateY(0);
        }
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .transfer-button {
            background-color: var(--accent-orange);
        }
        .transfer-button:hover:not(:disabled) {
            background-color: #d15a15;
        }

        /* Loading Spinner for buttons */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .request-list {
            margin-top: 15px;
        }

        .request-item {
            background-color: #f9f9f9;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-start;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .request-item div {
            width: 100%;
        }

        .request-item p {
            margin: 2px 0;
            font-size: 0.9em;
            color: var(--text-dark);
        }
        .request-item p strong {
            color: var(--primary-color);
        }

        .request-item .status {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 0.85em;
            align-self: flex-end;
        }

        .request-item .status.pending { background-color: var(--pending-color); color: var(--text-dark); }
        .request-item .status.approved { background-color: var(--approved-color); color: white; }
        .request-item .status.cancelled { background-color: var(--cancelled-color); color: white; }
        .request-item .status.completed { background-color: var(--approved-color); color: white; } /* For transfers */


        /* Bottom Navigation Bar - Premium Look (Re-used) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white-bg);
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 1100;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.95);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #777;
            font-size: 0.8em;
            font-weight: 600;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 5px 0;
            flex: 1;
            max-width: 90px;
            text-align: center;
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
            transform: translateY(-5px);
        }
        .bottom-nav-item:active {
            transform: translateY(-2px);
        }

        .bottom-nav-item .material-icons {
            font-size: 26px;
            margin-bottom: 3px;
        }

        /* Desktop/Tablet Styles */
        @media (min-width: 768px) {
            .header {
                padding: 15px 40px;
            }
            .content {
                padding: 20px 40px;
            }
            h2 {
                font-size: 2em;
            }
            .balance-section {
                gap: 15px;
                margin-bottom: 30px;
                flex-wrap: nowrap;
            }
            .main-balance-wrapper .balance-box {
                padding: 25px;
            }
            .balance-box h3 {
                font-size: 1em;
            }
            .balance-box .amount {
                font-size: 2em;
            }
            .balance-box.main-balance .amount {
                font-size: 2.5em;
            }
            .secondary-balances-wrapper {
                flex-wrap: nowrap;
            }

            .form-section, .history-section {
                padding: 30px;
                margin-bottom: 25px;
            }
            .tab-buttons {
                margin-bottom: 20px;
            }
            .tab-button {
                padding: 12px 25px;
                font-size: 1.1em;
            }
            .input-group {
                margin-bottom: 20px;
            }
            .input-group label {
                font-size: 1em;
            }
            .input-group select, .input-group input {
                padding: 12px 10px;
                font-size: 1em;
            }
            .amount-selection-buttons {
                gap: 15px;
                margin-bottom: 20px;
            }
            .amount-selection-buttons button {
                padding: 10px 15px;
                font-size: 1em;
                flex: 1 1 100px;
                min-width: 100px;
            }
            .charge-display {
                padding: 15px;
                font-size: 1em;
            }
            .charge-display .final-amount {
                font-size: 1.2em;
            }
            .action-button {
                padding: 14px 25px;
                font-size: 1.2em;
            }
            .loading-spinner {
                width: 20px;
                height: 20px;
            }
            .request-list {
                margin-top: 20px;
            }
            .request-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
            }
            .request-item p {
                font-size: 1em;
            }
            .request-item .status {
                font-size: 0.9em;
                align-self: center;
            }
            .bottom-nav {
                padding: 12px 0;
            }
            .bottom-nav-item {
                font-size: 0.9em;
            }
            .bottom-nav-item .material-icons {
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-name">Taka Gor</div>
        <span class="material-icons history-icon" id="toggle-history">history</span>
    </div>

    <div class="content">
        <h2>উইথড্র</h2>

        <div class="balance-section">
            <div class="main-balance-wrapper">
                <div class="balance-box main-balance">
                    <h3>Main Balance (মূল ব্যালেন্স)</h3>
                    <p class="amount" id="main-balance">৳ 0.00</p>
                </div>
            </div>
            <div class="secondary-balances-wrapper">
                <div class="balance-box income">
                    <h3>Income Balance (আয় ব্যালেন্স)</h3>
                    <p class="amount" id="income-balance">৳ 0.00</p>
                </div>
                <div class="balance-box referral">
                    <h3>Referral Balance (রেফারেল ব্যালেন্স)</h3>
                    <p class="amount" id="referral-balance">৳ 0.00</p>
                </div>
            </div>
        </div>

        <div class="form-section" id="withdraw-form-section">
            <div class="tab-buttons">
                <button class="tab-button active" id="withdraw-tab">উইথড্র</button>
                <button class="tab-button" id="transfer-tab">ব্যালেন্স ট্রান্সফার</button>
            </div>

            <div id="withdraw-content">
                <h3>উইথড্র রিকোয়েস্ট সাবমিট করুন</h3>
                <div class="input-group">
                    <label>পরিমাণ নির্বাচন করুন অথবা ইনপুট দিন</label>
                    <div class="amount-selection-buttons">
                        <button data-amount="200">৳ 200</button>
                        <button data-amount="300">৳ 300</button>
                        <button data-amount="500">৳ 500</button>
                        <button data-amount="1000">৳ 1000</button>
                    </div>
                    <input type="number" id="withdraw-amount" placeholder="অন্যান্য পরিমাণ (যেমন: 1500)" min="0" step="any">
                </div>

                <div class="charge-display">
                    <p>আপনি পাবেন: ৳ <strong id="amount-to-receive">0.00</strong></p>
                    <p>আপনার ব্যালেন্স থেকে কাটা হবে (১০% চার্জ সহ): ৳ <strong id="amount-to-deduct">0.00</strong></p>
                </div>

                <div class="input-group">
                    <label for="withdraw-method">পেমেন্ট পদ্ধতি</label>
                    <select id="withdraw-method">
                        <option value="">নির্বাচন করুন</option>
                        <option value="Bkash">বিকাশ</option>
                        <option value="Nagad">নগদ</option>
                        <option value="Rocket">রকেট</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="withdraw-account">অ্যাকাউন্ট নম্বর</label>
                    <input type="text" id="withdraw-account" placeholder="আপনার বিকাশ/নগদ/রকেট নম্বর">
                </div>
                <button class="action-button" id="submit-withdraw">
                    <span class="button-text">উইথড্র রিকোয়েস্ট পাঠান</span>
                    <div class="loading-spinner"></div>
                </button>
            </div>

            <div id="transfer-content" style="display: none;">
                <h3>ব্যালেন্স ট্রান্সফার করুন</h3>
                <div class="input-group">
                    <label for="transfer-from">থেকে</label>
                    <select id="transfer-from">
                        <option value="">নির্বাচন করুন</option>
                        <option value="income">ইনকাম ব্যালেন্স</option>
                        <option value="referral">রেফারেল ব্যালেন্স</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="transfer-to">উদ্দেশ্য</label>
                    <input type="text" value="Main Balance (মূল ব্যালেন্স)" readonly>
                </div>
                <div class="input-group">
                    <label for="transfer-amount">পরিমাণ</label>
                    <input type="number" id="transfer-amount" placeholder="ট্রান্সফার পরিমাণ" min="0" step="any">
                </div>
                <button class="action-button transfer-button" id="submit-transfer">
                    <span class="button-text">ট্রান্সফার করুন</span>
                    <div class="loading-spinner"></div>
                </button>
            </div>
        </div>

        <div class="history-section" id="history-section" style="display: none;">
            <h2>ট্রান্সফার এবং উইথড্র হিস্টোরি</h2>
            <div class="tab-buttons">
                <button class="tab-button active" id="withdraw-history-tab">উইথড্র হিস্টোরি</button>
                <button class="tab-button" id="transfer-history-tab">ট্রান্সফার হিস্টোরি</button>
            </div>

            <div id="withdraw-history-content" class="request-list">
                </div>
            <div id="transfer-history-content" class="request-list" style="display: none;">
                </div>
            <p id="no-history-message" style="text-align: center; color: var(--text-light); margin-top: 20px; display: none;">কোনো হিস্টোরি নেই।</p>
        </div>

    </div>

    <div class="bottom-nav">
        <a href="home.html" class="bottom-nav-item">
            <span class="material-icons">home</span>
            <span>হোম</span>
        </a>
        <a href="plans.html" class="bottom-nav-item">
            <span class="material-icons">redeem</span>
            <span>প্লান</span>
        </a>
        <a href="withdraw.html" class="bottom-nav-item active">
            <span class="material-icons">account_balance_wallet</span>
            <span>উইথড্র</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <span class="material-icons">person</span>
            <span>প্রোফাইল</span>
        </a>
    </div>

    <script type="module">
        // firebase_config.js থেকে auth এবং database ইম্পোর্ট করুন
        import { auth, database } from './js/firebase_config.js'; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { ref, onValue, push, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

        const mainBalanceElem = document.getElementById('main-balance');
        const incomeBalanceElem = document.getElementById('income-balance');
        const referralBalanceElem = document.getElementById('referral-balance');

        const withdrawTab = document.getElementById('withdraw-tab');
        const transferTab = document.getElementById('transfer-tab');
        const withdrawContent = document.getElementById('withdraw-content');
        const transferContent = document.getElementById('transfer-content');

        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const amountSelectionButtons = document.querySelectorAll('.amount-selection-buttons button');
        const amountToReceiveElem = document.getElementById('amount-to-receive');
        const amountToDeductElem = document.getElementById('amount-to-deduct');
        const withdrawMethodSelect = document.getElementById('withdraw-method');
        const withdrawAccountInput = document.getElementById('withdraw-account');
        const submitWithdrawBtn = document.getElementById('submit-withdraw');

        const transferFromSelect = document.getElementById('transfer-from');
        const transferAmountInput = document.getElementById('transfer-amount');
        const submitTransferBtn = document.getElementById('submit-transfer');

        const toggleHistoryBtn = document.getElementById('toggle-history');
        const withdrawFormSection = document.getElementById('withdraw-form-section');
        const historySection = document.getElementById('history-section');
        const withdrawHistoryTab = document.getElementById('withdraw-history-tab');
        const transferHistoryTab = document.getElementById('transfer-history-tab');
        const withdrawHistoryContent = document.getElementById('withdraw-history-content');
        const transferHistoryContent = document.getElementById('transfer-history-content');
        const noHistoryMessage = document.getElementById('no-history-message');

        let currentUserUid;
        let userBalances = { mainBalance: 0, incomeBalance: 0, referralBalance: 0 };
        const WITHDRAW_CHARGE_PERCENTAGE = 0.10; // 10% charge

        // Ensure user is authenticated before accessing page
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUid = user.uid;
                loadUserBalances(user.uid);
                loadWithdrawalHistory(user.uid);
                loadTransferHistory(user.uid);
                calculateWithdrawalAmounts(); // Initial calculation for 0 amount
            } else {
                window.location.href = 'index.html'; // Redirect to login if not authenticated
            }
        });

        function showButtonLoading(button, originalText) {
            const buttonText = button.querySelector('.button-text');
            const spinner = button.querySelector('.loading-spinner');
            if (buttonText && spinner) {
                button.disabled = true;
                buttonText.textContent = 'লোড হচ্ছে...';
                spinner.style.display = 'block';
            }
        }

        function hideButtonLoading(button, originalText) {
            const buttonText = button.querySelector('.button-text');
            const spinner = button.querySelector('.loading-spinner');
            if (buttonText && spinner) {
                button.disabled = false;
                buttonText.textContent = originalText;
                spinner.style.display = 'none';
            }
        }

        function loadUserBalances(uid) {
            const balancesRef = ref(database, `users/${uid}`);
            onValue(balancesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    userBalances.mainBalance = data.mainBalance || 0;
                    userBalances.incomeBalance = data.incomeBalance || 0;
                    userBalances.referralBalance = data.referralBalance || 0;

                    mainBalanceElem.textContent = `৳ ${userBalances.mainBalance.toFixed(2)}`;
                    incomeBalanceElem.textContent = `৳ ${userBalances.incomeBalance.toFixed(2)}`;
                    referralBalanceElem.textContent = `৳ ${userBalances.referralBalance.toFixed(2)}`;
                } else {
                    console.warn("No user balance data found for UID:", uid);
                    mainBalanceElem.textContent = `৳ 0.00`;
                    incomeBalanceElem.textContent = `৳ 0.00`;
                    referralBalanceElem.textContent = `৳ 0.00`;
                }
            }, (error) => {
                console.error("Error loading user balances:", error);
                alert("ব্যালেন্স লোড করতে সমস্যা হয়েছে।");
            });
        }

        // Tab Switching Logic
        withdrawTab.addEventListener('click', () => {
            withdrawTab.classList.add('active');
            transferTab.classList.remove('active');
            withdrawContent.style.display = 'block';
            transferContent.style.display = 'none';
        });

        transferTab.addEventListener('click', () => {
            transferTab.classList.add('active');
            withdrawTab.classList.remove('active');
            transferContent.style.display = 'block';
            withdrawContent.style.display = 'none';
        });

        // History Toggle Logic
        toggleHistoryBtn.addEventListener('click', () => {
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                withdrawFormSection.style.display = 'none';
                updateHistoryDisplay();
            } else {
                historySection.style.display = 'none';
                withdrawFormSection.style.display = 'block';
            }
        });

        withdrawHistoryTab.addEventListener('click', () => {
            withdrawHistoryTab.classList.add('active');
            transferHistoryTab.classList.remove('active');
            withdrawHistoryContent.style.display = 'block';
            transferHistoryContent.style.display = 'none';
            updateHistoryDisplay();
        });

        transferHistoryTab.addEventListener('click', () => {
            transferHistoryTab.classList.add('active');
            withdrawHistoryTab.classList.remove('active');
            transferHistoryContent.style.display = 'block';
            withdrawHistoryContent.style.display = 'none';
            updateHistoryDisplay();
        });

        function updateHistoryDisplay() {
            const noWithdrawalHistory = withdrawHistoryContent.children.length === 0;
            const noTransferHistory = transferHistoryContent.children.length === 0;

            if (historySection.style.display === 'block') {
                if (withdrawHistoryTab.classList.contains('active')) {
                    noHistoryMessage.style.display = noWithdrawalHistory ? 'block' : 'none';
                } else if (transferHistoryTab.classList.contains('active')) {
                    noHistoryMessage.style.display = noTransferHistory ? 'block' : 'none';
                }
            } else {
                noHistoryMessage.style.display = 'none';
            }
        }

        // Withdrawal Amount Calculation and Selection
        function calculateWithdrawalAmounts() {
            let amount = parseFloat(withdrawAmountInput.value) || 0;
            const charge = amount * WITHDRAW_CHARGE_PERCENTAGE;
            const totalDeduct = amount + charge;

            amountToReceiveElem.textContent = amount.toFixed(2);
            amountToDeductElem.textContent = totalDeduct.toFixed(2);
        }

        withdrawAmountInput.addEventListener('input', () => {
            // Remove 'selected' class from all predefined buttons
            amountSelectionButtons.forEach(btn => btn.classList.remove('selected'));
            calculateWithdrawalAmounts();
        });

        amountSelectionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                // Remove 'selected' class from previously selected button
                amountSelectionButtons.forEach(btn => btn.classList.remove('selected'));
                // Add 'selected' class to the clicked button
                e.target.classList.add('selected');

                const selectedAmount = parseFloat(e.target.dataset.amount);
                withdrawAmountInput.value = selectedAmount;
                calculateWithdrawalAmounts();
            });
        });

        // Submit Withdrawal Request
        submitWithdrawBtn.addEventListener('click', async () => {
            const requestedAmount = parseFloat(withdrawAmountInput.value);
            const method = withdrawMethodSelect.value;
            const accountNumber = withdrawAccountInput.value.trim();

            if (isNaN(requestedAmount) || requestedAmount <= 0) {
                alert('বৈধ পরিমাণ লিখুন।');
                return;
            }
            if (!method) {
                alert('পেমেন্ট পদ্ধতি নির্বাচন করুন।');
                return;
            }
            if (!accountNumber) {
                alert('অ্যাকাউন্ট নম্বর পূরণ করুন।');
                return;
            }

            const charge = requestedAmount * WITHDRAW_CHARGE_PERCENTAGE;
            const totalDeductAmount = requestedAmount + charge;

            if (userBalances.mainBalance < totalDeductAmount) {
                alert(`আপনার মূল ব্যালেন্সে পর্যাপ্ত টাকা নেই। (প্রয়োজন: ৳ ${totalDeductAmount.toFixed(2)}, আছে: ৳ ${userBalances.mainBalance.toFixed(2)})`);
                return;
            }

            if (!confirm(`আপনি ৳ ${requestedAmount.toFixed(2)} উইথড্র করতে চান? আপনার ব্যালেন্স থেকে ৳ ${totalDeductAmount.toFixed(2)} কাটা হবে।`)) {
                return;
            }

            showButtonLoading(submitWithdrawBtn, 'উইথড্র রিকোয়েস্ট পাঠান');

            try {
                // Deduct from Main Balance
                await runTransaction(ref(database, `users/${currentUserUid}/mainBalance`), (currentBalance) => {
                    if (currentBalance === null) return 0;
                    if (currentBalance < totalDeductAmount) {
                        console.log("Transaction aborted: Insufficient funds.");
                        return; // Abort transaction
                    }
                    return currentBalance - totalDeductAmount;
                });

                // Submit withdrawal request to admin and user's history
                const newWithdrawalRef = push(ref(database, 'withdrawals')); // For admin
                await set(newWithdrawalRef, {
                    userId: currentUserUid,
                    amountRequested: requestedAmount,
                    amountDeducted: totalDeductAmount,
                    charge: charge,
                    method: method,
                    accountNumber: accountNumber,
                    requestDate: serverTimestamp(),
                    status: 'Pending'
                });

                // Add to user's personal withdrawal history (redundant for direct display, but good for structure)
                const userWithdrawReqRef = push(ref(database, `users/${currentUserUid}/withdrawRequests`));
                await set(userWithdrawReqRef, {
                    amountRequested: requestedAmount,
                    amountDeducted: totalDeductAmount,
                    charge: charge,
                    method: method,
                    accountNumber: accountNumber,
                    requestDate: serverTimestamp(),
                    status: 'Pending'
                });

                alert('উইথড্র রিকোয়েস্ট সফলভাবে জমা দেওয়া হয়েছে!');
                withdrawAmountInput.value = '';
                withdrawMethodSelect.value = '';
                withdrawAccountInput.value = '';
                calculateWithdrawalAmounts(); // Reset display
                amountSelectionButtons.forEach(btn => btn.classList.remove('selected')); // Deselect buttons

                // Automatically redirect to history tab after successful withdrawal
                setTimeout(() => {
                    toggleHistoryBtn.click(); // Simulate click to show history
                    withdrawHistoryTab.click(); // Ensure withdrawal history is active
                }, 500); // Short delay for user to see alert
                

            } catch (error) {
                console.error("Error submitting withdrawal request:", error);
                if (error.message && error.message.includes("aborted")) {
                    alert('আপনার ব্যালেন্স আপডেটে সমস্যা হয়েছে, সম্ভবত অপর্যাপ্ত তহবিল।');
                } else {
                    alert('উইথড্র রিকোয়েস্ট জমা দিতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
                }
            } finally {
                hideButtonLoading(submitWithdrawBtn, 'উইথড্র রিকোয়েস্ট পাঠান');
            }
        });

        // Submit Balance Transfer
        submitTransferBtn.addEventListener('click', async () => {
            const fromBalanceKey = transferFromSelect.value; // 'income' or 'referral'
            const amount = parseFloat(transferAmountInput.value);

            if (!fromBalanceKey) {
                alert('ট্রান্সফার করার জন্য একটি উৎস ব্যালেন্স নির্বাচন করুন।');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert('বৈধ পরিমাণ লিখুন।');
                return;
            }

            const sourceBalance = userBalances[fromBalanceKey + 'Balance'];
            if (sourceBalance < amount) {
                alert(`আপনার ${fromBalanceKey === 'income' ? 'ইনকাম' : 'রেফারেল'} ব্যালেন্সে পর্যাপ্ত টাকা নেই।`);
                return;
            }

            if (!confirm(`আপনি ${fromBalanceKey === 'income' ? 'ইনকাম' ব্যালেন্স' : 'রেফারেল ব্যালেন্স'} থেকে ৳ ${amount.toFixed(2)} মূল ব্যালেন্সে ট্রান্সফার করতে চান?`)) {
                return;
            }
            
            showButtonLoading(submitTransferBtn, 'ট্রান্সফার করুন');

            try {
                // Perform the transfer using a transaction
                await runTransaction(ref(database, `users/${currentUserUid}`), (currentData) => {
                    if (currentData === null) return {};

                    const currentSourceBalance = currentData[fromBalanceKey + 'Balance'] || 0;
                    const currentMainBalance = currentData.mainBalance || 0;

                    if (currentSourceBalance < amount) {
                        console.log("Transaction aborted: Insufficient funds in source balance.");
                        return; // Abort transaction
                    }

                    currentData[fromBalanceKey + 'Balance'] = currentSourceBalance - amount;
                    currentData.mainBalance = currentMainBalance + amount;
                    return currentData;
                });

                // Save transfer history
                const userTransferReqRef = push(ref(database, `users/${currentUserUid}/transferHistory`));
                await set(userTransferReqRef, {
                    from: fromBalanceKey,
                    to: 'main',
                    amount: amount,
                    transferDate: serverTimestamp(),
                    status: 'Completed' // Transfers are instant and confirmed
                });

                alert('ব্যালেন্স সফলভাবে ট্রান্সফার হয়েছে!');
                transferAmountInput.value = '';
                transferFromSelect.value = '';
                
                // Automatically redirect to history tab after successful transfer
                setTimeout(() => {
                    toggleHistoryBtn.click(); // Simulate click to show history
                    transferHistoryTab.click(); // Ensure transfer history is active
                }, 500);

            } catch (error) {
                console.error("Error transferring balance:", error);
                if (error.message && error.message.includes("aborted")) {
                    alert('ব্যালেন্স ট্রান্সফারে সমস্যা হয়েছে, সম্ভবত অপর্যাপ্ত তহবিল।');
                } else {
                    alert('ব্যালেন্স ট্রান্সফার করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
                }
            } finally {
                hideButtonLoading(submitTransferBtn, 'ট্রান্সফার করুন');
            }
        });

        function loadWithdrawalHistory(uid) {
            const withdrawHistoryRef = ref(database, `users/${uid}/withdrawRequests`);
            onValue(withdrawHistoryRef, (snapshot) => {
                const requests = snapshot.val();
                withdrawHistoryContent.innerHTML = '';
                if (requests) {
                    // Convert object to array, sort by requestDate (latest first)
                    const sortedRequests = Object.keys(requests).map(key => ({ id: key, ...requests[key] }))
                                            .sort((a, b) => (b.requestDate || 0) - (a.requestDate || 0));

                    sortedRequests.forEach(req => {
                        const item = document.createElement('div');
                        item.classList.add('request-item');
                        const requestDate = req.requestDate ? new Date(req.requestDate).toLocaleString('bn-BD', { dateStyle: 'medium', timeStyle: 'short' }) : 'N/A';
                        item.innerHTML = `
                            <div>
                                <p>পরিমাণ: ৳ <strong>${req.amountRequested ? req.amountRequested.toFixed(2) : '0.00'}</strong></p>
                                <p>কাটা হয়েছে: ৳ <strong>${req.amountDeducted ? req.amountDeducted.toFixed(2) : '0.00'}</strong></p>
                                <p>পদ্ধতি: <strong>${req.method || 'N/A'}</strong> (${req.accountNumber || 'N/A'})</p>
                                <p>তারিখ: ${requestDate}</p>
                            </div>
                            <span class="status ${req.status ? req.status.toLowerCase() : 'unknown'}">${req.status || 'Unknown'}</span>
                        `;
                        withdrawHistoryContent.appendChild(item);
                    });
                }
                updateHistoryDisplay();
            }, (error) => {
                console.error("Error loading withdrawal history:", error);
                alert("উইথড্র হিস্টোরি লোড করতে সমস্যা হয়েছে।");
            });
        }

        function loadTransferHistory(uid) {
            const transferHistoryRef = ref(database, `users/${uid}/transferHistory`);
            onValue(transferHistoryRef, (snapshot) => {
                const requests = snapshot.val();
                transferHistoryContent.innerHTML = '';
                if (requests) {
                    // Convert object to array, sort by transferDate (latest first)
                    const sortedRequests = Object.keys(requests).map(key => ({ id: key, ...requests[key] }))
                                            .sort((a, b) => (b.transferDate || 0) - (a.transferDate || 0));

                    sortedRequests.forEach(req => {
                        const item = document.createElement('div');
                        item.classList.add('request-item');
                        const transferDate = req.transferDate ? new Date(req.transferDate).toLocaleString('bn-BD', { dateStyle: 'medium', timeStyle: 'short' }) : 'N/A';
                        item.innerHTML = `
                            <div>
                                <p>পরিমাণ: ৳ <strong>${req.amount ? req.amount.toFixed(2) : '0.00'}</strong></p>
                                <p>থেকে: <strong>${req.from === 'income' ? 'ইনকাম ব্যালেন্স' : 'রেফারেল ব্যালেন্স'}</strong></p>
                                <p>উদ্দেশ্য: <strong>Main Balance</strong></p>
                                <p>তারিখ: ${transferDate}</p>
                            </div>
                            <span class="status ${req.status ? req.status.toLowerCase() : 'unknown'}">${req.status || 'Unknown'}</span>
                        `;
                        transferHistoryContent.appendChild(item);
                    });
                }
                updateHistoryDisplay();
            }, (error) => {
                console.error("Error loading transfer history:", error);
                alert("ট্রান্সফার হিস্টোরি লোড করতে সমস্যা হয়েছে।");
            });
        }
    </script>
</body>
</html>